<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Check-In System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style> 
    body { background-color: #f0f2f5; font-family: 'Sarabun', sans-serif; padding-top:20px; } 
    .card { max-width: 400px; margin: 0 auto; border-radius: 15px; } 
    .loc-box { margin-bottom: 15px; padding: 15px; border-radius: 8px; font-size: 1rem; display: none; text-align: center; border: 2px solid transparent;}
    .loc-ok { background-color: #d1e7dd; color: #0f5132; border-color: #badbcc; }
    .loc-err { background-color: #f8d7da; color: #842029; border-color: #f5c2c7; }
    .loc-loading { background-color: #cfe2ff; color: #084298; border-color: #b6d4fe; }
    .liff-badge { color: #00B900; font-weight: bold; margin-bottom: 10px; font-size: 0.9rem; }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <div class="card p-4 text-center">
      <h2 class="mb-3 fw-bold">üìç ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h2>
      
      <div id="liffStatus"></div>
      <div id="gpsAlert" class="alert alert-warning">üõ∞Ô∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ GPS...</div>
      <div id="locationStatus" class="loc-box"></div>

      <form id="loginForm" style="display:none;" onsubmit="handleLogin(event)">
        <div class="mb-3 text-start">
          <label class="fw-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
          <select id="username" class="form-select" required>
            <option value="" disabled selected>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...</option>
          </select>
        </div>

        <div id="passwordArea" class="mb-3 text-start">
          <label class="fw-bold">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
          <input type="password" id="password" class="form-control" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
        </div>
        
        <button type="submit" id="submitBtn" class="btn btn-primary w-100">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</button>
      </form>
      
      <div id="statusBox" class="mt-3"></div>
    </div>
  </div>

  <script>
    // üî¥ 1. ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Web App ‡∏ó‡∏µ‡πà Deploy ‡πÅ‡∏•‡πâ‡∏ß (‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /exec)
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbz2HMxs_j29QkyuDH3V4bJVazndu1DE6tha8j6b0Qj29HXff3jCD0NT-7272WxwR-f8/exec"; 
    
    // üî¥ 2. ‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const MY_LIFF_ID = "2008958042-EpsJxKgH";

    var lat = 0, lng = 0;
    var isLiffAuthenticated = false;

    window.onload = function() {
      // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
      initLiff();
      
      // ‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(p) {
          lat = p.coords.latitude; 
          lng = p.coords.longitude;
          
          document.getElementById('gpsAlert').className = 'alert alert-success p-1';
          document.getElementById('gpsAlert').innerHTML = '‚úÖ GPS: ' + lat.toFixed(5) + ', ' + lng.toFixed(5);
          document.getElementById('loginForm').style.display = 'block';
          
          // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API)
          checkLocation(lat, lng);

        }, function(e) {
          document.getElementById('gpsAlert').className = 'alert alert-danger';
          document.getElementById('gpsAlert').innerHTML = '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS ‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï';
        }, {enableHighAccuracy: true});
      } else {
        alert("Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS");
      }

      // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API)
      loadEmployees();
    };

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô 1: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LIFF ---
    async function initLiff() {
      try {
        await liff.init({ liffId: MY_LIFF_ID });
        if (liff.isLoggedIn()) {
          const profile = await liff.getProfile();
          
          // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÑ‡∏õ‡πÄ‡∏ä‡πá‡∏Ñ UserID
          fetch(GAS_API_URL + "?action=checkLiff&uid=" + profile.userId)
            .then(res => res.json())
            .then(data => {
              if (data.status == 'found') {
                isLiffAuthenticated = true;
                // Auto Select ‡∏ä‡∏∑‡πà‡∏≠
                var select = document.getElementById('username');
                select.value = data.user;
                // ‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
                document.getElementById('passwordArea').style.display = 'none';
                document.getElementById('password').value = "LIFF_VERIFIED_BYPASS";
                // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                document.getElementById('liffStatus').innerHTML = '<div class="liff-badge">üëã ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ' + data.name + ' (LINE Login)</div>';
              }
            });
        } else {
          // ‡∏™‡∏±‡πà‡∏á Login
          liff.login();
        }
      } catch (err) { console.error("LIFF Error:", err); }
    }

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô 2: ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ---
    function loadEmployees() {
      fetch(GAS_API_URL + "?action=getUsers")
        .then(res => res.json())
        .then(users => {
          var select = document.getElementById('username');
          var oldVal = select.value;
          select.innerHTML = '<option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ --</option>';
          users.forEach(u => {
            var opt = document.createElement("option");
            opt.value = u.user; 
            opt.text = u.name;
            select.appendChild(opt);
          });
          if(oldVal) select.value = oldVal;
        })
        .catch(e => console.error("Load Users Error:", e));
    }

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô 3: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á ---
    function checkLocation(lat, lng) {
      var box = document.getElementById('locationStatus');
      box.style.display = 'block';
      box.className = 'loc-box loc-loading';
      box.innerHTML = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á...';

      fetch(GAS_API_URL + "?action=findLocation&lat=" + lat + "&lng=" + lng)
        .then(res => res.json())
        .then(data => {
           if(data.status == 'ok') {
             box.className = 'loc-box loc-ok';
             box.innerHTML = data.message;
           } else {
             box.className = 'loc-box loc-err';
             box.innerHTML = data.message;
           }
        })
        .catch(e => {
           box.className = 'loc-box loc-err';
           box.innerHTML = '‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ';
        });
    }

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô 4: ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ---
    function handleLogin(e) {
      e.preventDefault();
      var u = document.getElementById('username').value;
      var p = document.getElementById('password').value;
      var btn = document.getElementById('submitBtn');
      var statusBox = document.getElementById('statusBox');

      var workType = "NORMAL";
      var d = new Date().getDay();
      if(d===0 || d===6) {
        if(confirm("‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô:\n\n[OK] = OT\n[Cancel] = ‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥")) {
          workType = "OT";
        }
      }

      btn.disabled = true; 
      btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

      // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö POST (‡πÉ‡∏ä‡πâ text/plain ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á CORS Preflight)
      fetch(GAS_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({
          action: "checkIn",
          u: u, 
          p: p, 
          lat: lat, 
          lng: lng, 
          type: workType
        })
      })
      .then(res => res.json())
      .then(data => {
         btn.disabled = false; 
         btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤";
         
         if(data.status == 'success') {
           statusBox.className = 'alert alert-success';
           statusBox.innerHTML = data.message;
           // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ LIFF ‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
           if(!isLiffAuthenticated) document.getElementById('password').value = "";
           checkLocation(lat, lng);
         } else {
           statusBox.className = 'alert alert-danger';
           statusBox.innerHTML = data.message;
         }
      })
      .catch(err => {
         btn.disabled = false; 
         btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤";
         statusBox.className = 'alert alert-danger';
         statusBox.innerHTML = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
         console.error(err);
      });
    }
  </script>
</body>
</html>

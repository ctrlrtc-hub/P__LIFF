<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style> 
    body { background-color: #f0f2f5; font-family: 'Sarabun', sans-serif; padding-top:20px; } 
    .card { max-width: 400px; margin: 0 auto; border-radius: 15px; } 
    /* Style ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
    .loc-box { margin-bottom: 15px; padding: 15px; border-radius: 8px; font-size: 1rem; display: none; text-align: center; border: 2px solid transparent;}
    .loc-ok { background-color: #d1e7dd; color: #0f5132; border-color: #badbcc; }
    .loc-err { background-color: #f8d7da; color: #842029; border-color: #f5c2c7; }
    .loc-loading { background-color: #cfe2ff; color: #084298; border-color: #b6d4fe; }
    /* Style ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö LIFF info */
    .liff-badge { font-size: 0.9rem; margin-bottom: 10px; color: #00B900; font-weight: bold; }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <div class="card p-4 text-center">
      <h2 class="mb-3 fw-bold">üìç ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h2>
      
      <div id="liffStatus"></div>

      <div id="gpsAlert" class="alert alert-warning">üõ∞Ô∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ GPS...</div>
      
      <div id="locationStatus" class="loc-box"></div>

      <form id="loginForm" style="display:none;" onsubmit="handleLogin(event)">
        
        <div class="mb-3 text-start">
          <label class="fw-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
          <select id="username" class="form-select" required>
            <option value="" disabled selected>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...</option>
          </select>
        </div>

        <div id="passwordArea" class="mb-3 text-start">
          <label class="fw-bold">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
          <input type="password" id="password" class="form-control" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
        </div>
        
        <button type="submit" id="submitBtn" class="btn btn-primary w-100">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</button>
      </form>
      
      <div id="statusBox" class="mt-3"></div>
    </div>
  </div>

  <script>
    var lat, lng;
    var isLiffAuthenticated = false; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ LIFF
    
    window.onload = function() {
      // 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô LIFF (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)
      initLiff();

      // 2. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏´‡∏≤ GPS (‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°)
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(p) {
          lat = p.coords.latitude; lng = p.coords.longitude;
          
          // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏à‡∏≠ GPS ‡πÅ‡∏•‡πâ‡∏ß
          document.getElementById('gpsAlert').className = 'alert alert-success p-1';
          document.getElementById('gpsAlert').style.fontSize = '0.8rem';
          document.getElementById('gpsAlert').innerHTML = '‚úÖ GPS: ' + lat.toFixed(5) + ', ' + lng.toFixed(5);
          
          document.getElementById('loginForm').style.display = 'block';

          // ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
          autoDetectLocation(lat, lng);

        }, function(e) {
          document.getElementById('gpsAlert').className = 'alert alert-danger';
          document.getElementById('gpsAlert').innerHTML = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö GPS (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS)';
        }, {enableHighAccuracy: true});
      } else { alert("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS"); }

      loadEmployeeList();
    };

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ LIFF Login
    async function initLiff() {
      try {
        // ‚ö†Ô∏è‚ö†Ô∏è ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ID ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‚ö†Ô∏è‚ö†Ô∏è
        //await liff.init({ liffId: "‡πÉ‡∏™‡πà_LIFF_ID_‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà" });
        await liff.init({ liffId: "2008958042-EpsJxKgH" });
        if (liff.isLoggedIn()) {
          const profile = await liff.getProfile();
          // ‡∏™‡πà‡∏á UserId ‡πÑ‡∏õ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏±‡∏ö Google Sheet
          google.script.run.withSuccessHandler(function(res) {
            if (res.status == 'found') {
              // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö:
              isLiffAuthenticated = true;
              
              // 1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
              var select = document.getElementById('username');
              select.value = res.user;
              
              // 2. ‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
              document.getElementById('passwordArea').style.display = 'none';
              
              // 3. ‡∏¢‡∏±‡∏î‡∏Ñ‡πà‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÉ‡∏ô code.gs)
              document.getElementById('password').value = "LIFF_VERIFIED_BYPASS"; 
              
              // 4. ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢
              document.getElementById('liffStatus').innerHTML = '<div class="liff-badge">üëã ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì ' + res.name + ' (LINE Login)</div>';
            }
          }).checkLiffLogin(profile.userId);
        } else {
          // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Login ‡πÉ‡∏´‡πâ Login ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏°‡∏∑‡∏≠‡∏Å‡πá‡πÑ‡∏î‡πâ)
          liff.login();
        }
      } catch (err) {
        console.log("LIFF Error: ", err);
      }
    }

    function loadEmployeeList() {
      google.script.run.withSuccessHandler(function(users) {
        var select = document.getElementById('username');
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ú‡∏∑‡πà‡∏≠ LIFF set ‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
        var currentVal = select.value;
        
        select.innerHTML = '<option value="" disabled selected>-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì --</option>';
        users.forEach(function(u) {
          var option = document.createElement("option");
          option.value = u.user; 
          option.text = u.name; 
          select.appendChild(option);
        });

        // ‡∏ñ‡πâ‡∏≤ LIFF ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ set ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
        if (currentVal && currentVal !== "") {
            select.value = currentVal;
        }

      }).getEmployeeList();
    }

    function autoDetectLocation(lat, lng) {
      var locBox = document.getElementById('locationStatus');
      
      locBox.style.display = 'block';
      locBox.className = 'loc-box loc-loading';
      locBox.innerHTML = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà...';

      google.script.run.withSuccessHandler(function(res) {
        if (res.status == 'ok') {
          locBox.className = 'loc-box loc-ok'; 
          locBox.innerHTML = res.message; 
        } else {
          locBox.className = 'loc-box loc-err'; 
          locBox.innerHTML = res.message;
        }
      }).findNearestLocation(lat, lng);
    }

    function handleLogin(e) {
      e.preventDefault();
      var u = document.getElementById('username').value;
      var p = document.getElementById('password').value;
      var btn = document.getElementById('submitBtn');
      var statusBox = document.getElementById('statusBox');
      
      var workType = ""; 
      var today = new Date();
      var dayOfWeek = today.getDay(); 

      if (dayOfWeek === 0 || dayOfWeek === 6) {
         var isOT = confirm("‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î\n‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤:\n\nOK = ‡∏•‡∏á OT\nCancel = ‡∏•‡∏á‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥");
         workType = isOT ? "OT" : "NORMAL";
      }

      btn.disabled = true; btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
      
      google.script.run.withSuccessHandler(function(res) {
        btn.disabled = false; btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤";
        statusBox.className = (res.status == 'success') ? 'alert alert-success' : 'alert alert-danger';
        statusBox.innerHTML = res.message;
        
        if(res.status == 'success') {
           // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Login ‡∏ú‡πà‡∏≤‡∏ô LIFF ‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
           if (!isLiffAuthenticated) {
             document.getElementById('password').value = "";
           }
           autoDetectLocation(lat, lng); // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏∞‡∏¢‡∏∞‡∏ã‡πâ‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå
        }
      }).processCheckIn(u, p, lat, lng, workType); 
    }
  </script>
</body>
</html>
